var form = $("<%= escape_javascript(render('form')) %>");

var references = {};
var referencesLabels = [], selectedReferences = [];
var taxon_concept_id = <%= @taxon_concept.id %>;

form.find('input.typeahead').typeahead({
  source: function(query, process)  {
    $.get(
      '/admin/references/autocomplete',
      { query: query },
      function (data) {
        _.each(data, function(item, i, list) {
          if (_.has(references, item.value)) {
            item.value = item.value + ' (' + item.id + ')';
          }

          referencesLabels.push(item.value);
          references[item.value] = item.id;
        });

        return process(referencesLabels);
      }
    );
  },
  updater: function(item) {
    if (!_.contains(selectedReferences, item)) {
      selectedReferences.push(item);
      // Coerce nested_form in to adding a new nested reference form field set
      form.find('#addReference').click();
      // Select the form field set added by nested_form
      var $field = form.find('.fields').last()

      // Display the selected 
      $field.find('span').text(item);

      // nested_form creates fields with unique (time based IDs),
      // so we determine which field is which based on order as this is faster than using a regex.
      var inputs = $field.find('input[id^="taxon_concept_taxon_concept_references_attributes_"][type="text"]');

      // Reference ID
      $(inputs[0]).val(references[item]);
      // Taxon Concept ID
      $(inputs[1]).val(taxon_concept_id);
    }
  }
});


$('#admin-new-taxon_concept_reference-form').html(form);
$('#new-taxon_concept_reference').modal('show');

$('.nav-tabs a').click(function (e) {
  e.preventDefault();
  $(this).tab('show');
});
